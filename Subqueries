# This file contains SQL queries that demonstrate the use of subqueries in the Rockbuster Stealth case study. They include calculating the average payment of the top 5 customers and analyzing their distribution across different countries
## Average amount paid by the Top 5 Customers 
select avg(total_amount_paid) as average_amount_paid
FROM
(
    select customer.customer_id, first_name, last_name, city, country,
           sum(amount) as total_amount_paid
    from customer
    INNER JOIN payment on payment.customer_id = customer.customer_id
    INNER JOIN address on customer.address_id = address.address_id
    INNER JOIN city    on address.city_id = city.city_id
    INNER JOIN country on city.country_id = country.country_id
    WHERE city IN ('Aurora','Acua','Citrus Heights','Iwaki','Ambattur',
                   'Shanwei','So Leopoldo','Teboksary','Tianjin','Cianjur')
    group by customer.customer_id, first_name, last_name, city, country
    order by total_amount_paid desc
    Limit 5
) as average;
## Top 5 Customers per Country 
select country.country,
       count(distinct customer.customer_id) as all_customer_count,
       count(distinct top_5_customers.customer_id) as top_customer_count
from customer
INNER JOIN address ON customer.address_id = address.address_id
INNER JOIN city    ON address.city_id = city.city_id
INNER JOIN country ON city.country_id = country.country_id
LEFT JOIN
(
    select customer.customer_id, first_name, last_name, city, country,
           sum(amount) as total_amount_paid
    from customer
    INNER JOIN payment on payment.customer_id = customer.customer_id
    INNER JOIN address on customer.address_id = address.address_id
    INNER JOIN city    on address.city_id = city.city_id
    INNER JOIN country on city.country_id = country.country_id
    WHERE city IN ('Aurora','Acua','Citrus Heights','Iwaki','Ambattur',
                   'Shanwei','So Leopoldo','Teboksary','Tianjin','Cianjur')
    group by customer.customer_id, first_name, last_name, city, country
    order by total_amount_paid desc
    limit 5
) as top_5_customers
    ON top_5_customers.country = country.country
group by country.country
order by top_customer_count desc,
         all_customer_count desc
limit 5;
